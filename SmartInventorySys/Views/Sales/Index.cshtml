@model IEnumerable<SmartInventorySys.Models.Product>

<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-md-5">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="m-0"><i class="fas fa-barcode"></i> Select Products</h5>
                </div>
                <div class="card-body">
                    <label class="fw-bold">Search Product</label>

                    <input class="form-control mb-3" list="productOptions" id="productInput" placeholder="Type product name..." onchange="selectProduct()">

                    <datalist id="productOptions">
                        @foreach (var p in Model)
                        {
                            // We put the NAME in the value, and ID/Price in data attributes if possible,
                            // but datalist is simple. We will lookup details in JS.
                            <option value="@p.Name">Price: @p.Price | Stock: @p.StockQuantity</option>
                        }
                    </datalist>

                    <input type="hidden" id="selectedId">
                    <input type="hidden" id="selectedPrice">
                    <input type="hidden" id="selectedStock">

                    <div class="row">
                        <div class="col-6">
                            <label class="fw-bold">Quantity</label>
                            <input type="number" id="qty" class="form-control" value="1" min="1">
                        </div>
                        <div class="col-6 d-flex align-items-end">
                            <button class="btn btn-success w-100" onclick="addToCart()">
                                <i class="fas fa-plus"></i> Add to Bill
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow-sm h-100">

                <div class="mb-3">
                    <label class="fw-bold">Order Note / Comment <span class="text-danger">*</span></label>
                    <textarea id="orderComments" class="form-control" rows="2" placeholder="e.g. Customer Phone: 98xxx..."></textarea>
                </div>
                <div class="card-header bg-dark text-white d-flex justify-content-between">
                    <h5 class="m-0">Current Bill</h5>
                    <span id="billDate">@DateTime.Now.ToString("yyyy-MM-dd")</span>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="table-responsive flex-grow-1">
                        <table class="table table-bordered table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th>Item</th>
                                    <th>Price</th>
                                    <th>Qty</th>
                                    <th>Total</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="cartTable"></tbody>
                        </table>
                    </div>

                    <div class="mt-3 border-top pt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Sub Total:</span>
                            <span class="fw-bold">Rs. <span id="subTotal">0.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Discount (%):</span>
                            <input type="number" id="discountPercent" class="form-control form-control-sm text-end" value="0" min="0" max="100" style="width: 80px;" onchange="renderTable()">
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>VAT (13%):</span>
                            <span class="fw-bold">Rs. <span id="taxAmount">0.00</span></span>
                        </div>
                        <h3 class="text-end fw-bold text-primary border-top pt-2">Total: Rs. <span id="grandTotal">0.00</span></h3>

                        <div class="row mt-4">
                            <div class="col-4">
                                <button class="btn btn-primary w-100 py-3 fw-bold shadow-sm" onclick="checkout('Cash')">Cash</button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-secondary w-100 py-3 fw-bold shadow-sm" style="background-color: #5C2D91; border:none; color: white;" onclick="checkout('Khalti')">Khalti</button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-success w-100 py-3 fw-bold shadow-sm" style="background-color: #61ca39; border: none;" onclick="checkout('Esewa')">eSewa</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var productDb = [
        @foreach (var p in Model)
        {
                @:{ id: "@p.Id", name: "@p.Name", price: @p.Price, stock: @p.StockQuantity },
        }
    ];
</script>

@section Scripts {
    <script>
        let cart = [];

        function selectProduct() {
            var inputVal = document.getElementById("productInput").value;
            // Find product in our JS database
            var product = productDb.find(x => x.name === inputVal);

            if (product) {
                document.getElementById("selectedId").value = product.id;
                document.getElementById("selectedPrice").value = product.price;
                document.getElementById("selectedStock").value = product.stock;
            } else {
                document.getElementById("selectedId").value = "";
            }
        }

        function addToCart() {
            var productId = document.getElementById("selectedId").value;
            var productName = document.getElementById("productInput").value;
            var price = parseFloat(document.getElementById("selectedPrice").value);
            var stock = parseInt(document.getElementById("selectedStock").value);
            var qty = parseInt(document.getElementById("qty").value);

            if (!productId) { alert("Please select a valid product from the list"); return; }
            if (qty > stock) { alert("Not enough stock! Available: " + stock); return; }

            let existing = cart.find(x => x.ProductId == productId);
            if(existing) {
                if((existing.Quantity + qty) > stock) {
                     alert("Cannot add more. Total stock limit reached.");
                     return;
                }
                existing.Quantity += qty;
            } else {
                cart.push({ ProductId: productId, Name: productName, Price: price, Quantity: qty });
            }

            renderTable();

            // Reset
            document.getElementById("productInput").value = "";
            document.getElementById("selectedId").value = "";
            document.getElementById("qty").value = 1;
            document.getElementById("productInput").focus();
        }

        function renderTable() {
            let tbody = document.getElementById("cartTable");
            tbody.innerHTML = "";
            let subTotal = 0;

            cart.forEach((item, index) => {
                let rowTotal = item.Price * item.Quantity;
                subTotal += rowTotal;

                tbody.innerHTML += `
                    <tr>
                        <td>${item.Name}</td>
                        <td>${item.Price}</td>
                        <td>${item.Quantity}</td>
                        <td>${rowTotal}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="removeItem(${index})"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });

            let discountPercent = parseFloat(document.getElementById("discountPercent").value) || 0;
            let discountAmount = (subTotal * discountPercent) / 100;
            let taxable = subTotal - discountAmount;
            let tax = taxable * 0.13;
            let grandTotal = taxable + tax;

            document.getElementById("subTotal").innerText = subTotal.toFixed(2);
            document.getElementById("taxAmount").innerText = tax.toFixed(2);
            document.getElementById("grandTotal").innerText = grandTotal.toFixed(2);
        }

        function removeItem(index) {
            cart.splice(index, 1);
            renderTable();
        }


                function checkout(paymentType) {
            if(cart.length === 0) { alert("Cart is empty!"); return; }

            // 1. Validate Comment
            let comments = document.getElementById("orderComments").value.trim();
            if (!comments) {
                alert("⚠️ Comment is required! Please enter customer details or a note.");
                document.getElementById("orderComments").focus();
                return;
            }

            let discountPercent = parseFloat(document.getElementById("discountPercent").value) || 0;

            let cleanCart = cart.map(item => ({
                ProductId: parseInt(item.ProductId),
                Quantity: parseInt(item.Quantity)
            }));

            // 2. Add Comments to Payload
            let payload = {
                CartItems: cleanCart,
                DiscountPercent: discountPercent,
                Comments: comments // <--- Send to Server
            };

            $.ajax({
                url: '/Sales/Checkout',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (response) {
                    if (response.success) {
                        if (paymentType === 'Khalti') initiateKhalti(response.id);
                        else if (paymentType === 'Esewa') submitEsewa(response.id, response.invoiceId, response.totalAmount);
                        else window.location.href = "/Sales/Invoice/" + response.id;
                    } else {
                        alert("Failed: " + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    alert("Server Error: " + error);
                }
            });
        }

        // ... Keep initiateKhalti and submitEsewa functions here ...
        function initiateKhalti(orderId) {
             $.ajax({
                url: '/Sales/PayWithKhalti',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(orderId),
                success: function (resp) {
                    if(resp.success) window.location.href = resp.paymentUrl;
                    else alert("Khalti Failed: " + resp.message);
                }
            });
        }
        function submitEsewa(dbId, invoiceNo, amount) {
            var form = document.getElementById("esewaForm");
            // Dynamic form creation if needed, or stick to the hidden one
            document.getElementById("tAmt").value = amount;
            document.getElementById("amt").value = amount;
            document.getElementById("pid").value = invoiceNo;
            form.submit();
        }
    </script>
}